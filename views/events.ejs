<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Ella Rises CRM</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background min-h-screen flex">
    <!-- Sidebar Navigation -->
    <%- include('partials/sidebar', { user: user, currentPage: 'events' }) %>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Page Header -->
            <div class="mb-8 flex items-center justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-serif text-foreground mb-2">Events</h1>
                    <p class="text-base text-card-foreground/70">Manage workshops and programs</p>
                </div>
                <% if (user.role === 'manager') { %>
                <a href="/events/create" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                    + Create Event
                </a>
                <% } %>
            </div>

            <!-- Action Bar -->
            <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <!-- Search Bar -->
                <div class="relative flex-1 w-full max-w-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="Search events..." 
                        value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
                        class="w-full pl-10 pr-4 py-2.5 border border-input rounded-md bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors"
                    />
                </div>

                <% if (user.role !== 'donor') { %>
                <!-- Filters for Event Type and Recurrence -->
                <div class="flex flex-wrap gap-3 md:ml-4 md:flex-none">
                    <select id="eventTypeFilter" class="min-w-[180px] h-10 px-3 py-2 border border-input rounded-md bg-background text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                        <option value="">All Event Types</option>
                        <% if (Array.isArray(eventTypes)) { %>
                            <% eventTypes.forEach(function(type) { %>
                                <option value="<%= type %>"><%= type %></option>
                            <% }) %>
                        <% } %>
                    </select>
                    <select id="recurrenceFilter" class="min-w-[180px] h-10 px-3 py-2 border border-input rounded-md bg-background text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                        <option value="">All Recurrence Patterns</option>
                        <% if (Array.isArray(recurrencePatterns)) { %>
                            <% recurrencePatterns.forEach(function(pattern) { %>
                                <option value="<%= pattern %>"><%= pattern %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                <% } %>
            </div>

            <!-- Tab Navigation and Sort -->
            <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex gap-3">
                    <button id="upcomingTab" class="tab-button inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-primary text-primary-foreground shadow-sm">
                        Upcoming Events
                    </button>
                    <% if (user.role === 'user') { %>
                    <button id="myEventsTab" class="tab-button inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium border border-transparent bg-transparent text-muted-foreground hover:bg-muted hover:text-foreground">
                        My Upcoming Events
                    </button>
                    <% } %>
                    <button id="pastTab" class="tab-button inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium border border-transparent bg-transparent text-muted-foreground hover:bg-muted hover:text-foreground">
                        Past Events
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label for="sortOrder" class="text-sm text-muted-foreground">Sort by:</label>
                    <select id="sortOrder" class="h-10 px-3 py-2 border border-input rounded-md bg-background text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                        <option value="asc">Soonest First</option>
                        <option value="desc">Latest First</option>
                    </select>
                </div>
            </div>

            <!-- Success Messages -->
            <% if (typeof query !== 'undefined' && query.success === 'registered') { %>
            <div id="eventsSuccessMessage" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-sm text-green-800 font-medium">You have successfully registered for the event!</p>
            </div>
            <% } else if (typeof query !== 'undefined' && query.success === 'cancelled') { %>
            <div id="eventsSuccessMessage" class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-sm text-amber-800 font-medium">Your registration has been cancelled.</p>
            </div>
            <% } %>

            <!-- Events List -->
            <div class="space-y-6">
                <!-- Upcoming Events -->
                <div id="upcomingEvents" class="events-container space-y-6">
                    <% if (typeof currentSessions !== 'undefined' && currentSessions.length > 0) { %>
                        <% currentSessions.forEach(session => { %>
                            <% 
                                const startDate = new Date(session.eventdatetimestart);
                                const endDate = new Date(session.eventdatetimeend);
                                const regDeadline = session.eventregistrationdeadline ? new Date(session.eventregistrationdeadline) : null;
                                const capacity = session.eventcapacity || session.eventdefaultcapacity || 'N/A';
                                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
                                const formattedStartTime = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                            %>
                            <div class="event-card bg-card rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow" 
                                 data-name="<%= session.eventname.toLowerCase() %>"
                                 data-description="<%= (session.eventdescription || '').toLowerCase() %>"
                                 data-location="<%= (session.eventlocation || '').toLowerCase() %>"
                                 data-type="<%= (session.eventtype || '').toLowerCase() %>"
                                 data-recurrence="<%= (session.eventrecurrencepattern || '').toLowerCase() %>"
                                 data-start-date="<%= new Date(session.eventdatetimestart).getTime() %>">
                                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-start gap-3 mb-2">
                                            <h3 class="text-xl font-semibold text-card-foreground"><%= session.eventname %></h3>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent text-accent-foreground"><%= session.eventtype %></span>
                                        </div>
                                        <% if (session.eventdescription) { %>
                                        <p class="text-sm text-card-foreground/70 mb-4"><%= session.eventdescription %></p>
                                        <% } %>
                                        <div class="flex flex-wrap gap-4 text-sm text-card-foreground/70">
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <span><%= formattedStartDate %> at <%= formattedStartTime %></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                <span>Capacity: <%= capacity %></span>
                                            </div>
                                            <% if (session.eventlocation) { %>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                <span><%= session.eventlocation %></span>
                                            </div>
                                            <% } %>
                                            <% if (regDeadline) { %>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span>Registration Deadline: <%= regDeadline.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) %> <%= regDeadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                                        <% 
                                            const isParticipant = user.role === 'user';
                                            const isManager = user.role === 'manager';
                                            const deadlinePassed = session.registrationDeadlinePassed;
                                            const isRegistered = !!session.isRegistered;
                                            const isCancelled = session.registrationStatus === 'cancelled';
                                            const isFull = !!session.isFull;

                                            const canRegister = isParticipant && !deadlinePassed && !isFull && (!isRegistered || isCancelled);
                                            const canCancel = isParticipant && !deadlinePassed && isRegistered && !isCancelled;

                                            // Check if Take Attendance button should be shown (within 1 hour before start and up to 3 hours after end)
                                            let showTakeAttendance = false;
                                            if (isManager) {
                                                const now = new Date();
                                                const startDate = new Date(session.eventdatetimestart);
                                                const endDate = new Date(session.eventdatetimeend);
                                                const oneHourBeforeStart = new Date(startDate.getTime() - 60 * 60 * 1000);
                                                const threeHoursAfterEnd = new Date(endDate.getTime() + 3 * 60 * 60 * 1000);
                                                
                                                // Show button from 1 hour before start until 3 hours after end
                                                showTakeAttendance = (now >= oneHourBeforeStart && now <= threeHoursAfterEnd);
                                            }
                                        %>

                                        <% if (isManager && showTakeAttendance) { %>
                                            <a href="/events/<%= session.sessionid %>/attendance" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                                Take Attendance
                                            </a>
                                        <% } %>

                                        <% if (isParticipant) { %>
                                            <% if (deadlinePassed) { %>
                                                <button 
                                                    type="button"
                                                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 cursor-not-allowed bg-muted text-muted-foreground"
                                                    aria-disabled="true"
                                                >
                                                    Registration Has Passed
                                                </button>
                                            <% } else if (canCancel) { %>
                                                <button 
                                                    type="button"
                                                    class="register-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground"
                                                    data-session-id="<%= session.sessionid %>"
                                                    data-session-name="<%= session.eventname %>"
                                                    data-action="cancel"
                                                    data-return-tab="upcoming"
                                                >
                                                    Cancel Registration
                                                </button>
                                            <% } else if (canRegister) { %>
                                                <button 
                                                    type="button"
                                                    class="register-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90"
                                                    data-session-id="<%= session.sessionid %>"
                                                    data-session-name="<%= session.eventname %>"
                                                    data-action="register"
                                                    data-return-tab="upcoming"
                                                >
                                                    Register
                                                </button>
                                            <% } else if (isFull) { %>
                                                <button 
                                                    type="button"
                                                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 cursor-not-allowed bg-muted text-muted-foreground"
                                                    aria-disabled="true"
                                                >
                                                    No Seats Available
                                                </button>
                                            <% } %>
                                        <% } %>

                                        <a href="/events/<%= session.sessionid %>?from=upcoming" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="bg-card rounded-lg p-8 text-center">
                            <p class="text-muted-foreground mb-6 pt-4">No upcoming events found.</p>
                            <% if (user.role === 'manager') { %>
                            <a href="/events/create" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 mb-4">
                                + Create Event
                            </a>
                            <% } %>
                        </div>
                    <% } %>
                </div>

                <!-- My Upcoming Events (Participant Only - Registered Events) -->
                <% if (user.role === 'user') { %>
                <div id="myEvents" class="events-container hidden space-y-6">
                    <% 
                        const myRegisteredSessions = (typeof currentSessions !== 'undefined' ? currentSessions : [])
                            .filter(s => s.isRegistered && s.registrationStatus !== 'cancelled');
                    %>
                    <% if (myRegisteredSessions.length > 0) { %>
                        <% myRegisteredSessions.forEach(session => { %>
                            <% 
                                const startDate = new Date(session.eventdatetimestart);
                                const endDate = new Date(session.eventdatetimeend);
                                const regDeadline = session.eventregistrationdeadline ? new Date(session.eventregistrationdeadline) : null;
                                const capacity = session.eventcapacity || session.eventdefaultcapacity || 'N/A';
                                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
                                const formattedStartTime = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                            %>
                            <div class="event-card bg-card rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow" 
                                 data-name="<%= session.eventname.toLowerCase() %>"
                                 data-description="<%= (session.eventdescription || '').toLowerCase() %>"
                                 data-location="<%= (session.eventlocation || '').toLowerCase() %>"
                                 data-type="<%= (session.eventtype || '').toLowerCase() %>"
                                 data-recurrence="<%= (session.eventrecurrencepattern || '').toLowerCase() %>"
                                 data-start-date="<%= new Date(session.eventdatetimestart).getTime() %>">
                                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-start gap-3 mb-2">
                                            <h3 class="text-xl font-semibold text-card-foreground"><%= session.eventname %></h3>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent text-accent-foreground"><%= session.eventtype %></span>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Registered</span>
                                        </div>
                                        <% if (session.eventdescription) { %>
                                        <p class="text-sm text-card-foreground/70 mb-4"><%= session.eventdescription %></p>
                                        <% } %>
                                        <div class="flex flex-wrap gap-4 text-sm text-card-foreground/70">
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <span><%= formattedStartDate %> at <%= formattedStartTime %></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                <span>Capacity: <%= capacity %></span>
                                            </div>
                                            <% if (session.eventlocation) { %>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                <span><%= session.eventlocation %></span>
                                            </div>
                                            <% } %>
                                            <% if (regDeadline) { %>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span>Registration Deadline: <%= regDeadline.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) %> <%= regDeadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                                        <% const deadlinePassed = session.registrationDeadlinePassed; %>
                                        <% if (!deadlinePassed) { %>
                                        <button 
                                            type="button"
                                            class="register-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground"
                                            data-session-id="<%= session.sessionid %>"
                                            data-session-name="<%= session.eventname %>"
                                            data-action="cancel"
                                            data-return-tab="myevents"
                                        >
                                            Cancel Registration
                                        </button>
                                        <% } %>
                                        <a href="/events/<%= session.sessionid %>?from=myevents" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="bg-card rounded-lg p-8 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-muted-foreground mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-muted-foreground mb-4">You haven't registered for any upcoming events yet.</p>
                            <button onclick="switchTab('upcoming')" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                Browse Upcoming Events
                            </button>
                        </div>
                    <% } %>
                </div>
                <% } %>

                <!-- Past Events -->
                <div id="pastEvents" class="events-container hidden space-y-6">
                    <% if (typeof pastSessions !== 'undefined' && pastSessions.length > 0) { %>
                        <% pastSessions.forEach(session => { %>
                            <% 
                                const startDate = new Date(session.eventdatetimestart);
                                const endDate = new Date(session.eventdatetimeend);
                                const regDeadline = session.eventregistrationdeadline ? new Date(session.eventregistrationdeadline) : null;
                                const capacity = session.eventcapacity || session.eventdefaultcapacity || 'N/A';
                                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
                                const formattedStartTime = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                const isCancelled = session.registrationStatus === 'cancelled';
                                const isNoShow = session.registrationStatus === 'no-show';
                                const isAttended = session.registrationStatus === 'attended';
                            %>
                            <div class="event-card bg-card rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow <%= isCancelled ? 'border-l-4 border-red-400' : '' %>" 
                                 data-name="<%= session.eventname.toLowerCase() %>"
                                 data-description="<%= (session.eventdescription || '').toLowerCase() %>"
                                 data-location="<%= (session.eventlocation || '').toLowerCase() %>"
                                 data-type="<%= (session.eventtype || '').toLowerCase() %>"
                                 data-recurrence="<%= (session.eventrecurrencepattern || '').toLowerCase() %>"
                                 data-start-date="<%= new Date(session.eventdatetimestart).getTime() %>">
                                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-start gap-3 mb-2 flex-wrap">
                                            <h3 class="text-xl font-semibold text-card-foreground"><%= session.eventname %></h3>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent text-accent-foreground"><%= session.eventtype %></span>
                                            <% if (user.role === 'user') { %>
                                                <% if (isCancelled) { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                    Cancelled
                                                </span>
                                                <% } else if (isNoShow) { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">No-Show</span>
                                                <% } else if (isAttended) { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Attended</span>
                                                <% } else if (session.isRegistered) { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Completed</span>
                                                <% } %>
                                            <% } %>
                                        </div>
                                        <% if (session.eventdescription) { %>
                                        <p class="text-sm text-card-foreground/70 mb-4"><%= session.eventdescription %></p>
                                        <% } %>
                                        <div class="flex flex-wrap gap-4 text-sm text-card-foreground/70">
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <span><%= formattedStartDate %> at <%= formattedStartTime %></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                <span>Capacity: <%= capacity %></span>
                                            </div>
                                            <% if (session.eventlocation) { %>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                <span><%= session.eventlocation %></span>
                                            </div>
                                            <% } %>
                                            <% if (regDeadline) { %>
                                            <div class="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span>Registration Deadline: <%= regDeadline.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) %> <%= regDeadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <a href="/events/<%= session.sessionid %>?from=past" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="bg-card rounded-lg p-8 text-center">
                            <p class="text-muted-foreground">
                                <% if (user.role === 'user') { %>
                                    No past event history found.
                                <% } else { %>
                                    No past events found.
                                <% } %>
                            </p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Tab switching functionality
        const upcomingTab = document.getElementById('upcomingTab');
        const pastTab = document.getElementById('pastTab');
        const myEventsTab = document.getElementById('myEventsTab');
        const upcomingEvents = document.getElementById('upcomingEvents');
        const pastEvents = document.getElementById('pastEvents');
        const myEvents = document.getElementById('myEvents');

        function setTabInactive(tab) {
            if (tab) {
                tab.classList.remove('bg-primary', 'text-primary-foreground', 'shadow-sm');
                tab.classList.add('bg-transparent', 'text-muted-foreground', 'border', 'border-transparent');
            }
        }

        function setTabActive(tab) {
            if (tab) {
                tab.classList.add('bg-primary', 'text-primary-foreground', 'shadow-sm');
                tab.classList.remove('bg-transparent', 'text-muted-foreground', 'border', 'border-transparent');
            }
        }

        function switchTab(activeTab) {
            // Reset all tabs to inactive
            setTabInactive(upcomingTab);
            setTabInactive(pastTab);
            setTabInactive(myEventsTab);

            // Hide all containers
            if (upcomingEvents) upcomingEvents.classList.add('hidden');
            if (pastEvents) pastEvents.classList.add('hidden');
            if (myEvents) myEvents.classList.add('hidden');

            // Activate the selected tab and show its container
            if (activeTab === 'upcoming') {
                setTabActive(upcomingTab);
                if (upcomingEvents) upcomingEvents.classList.remove('hidden');
            } else if (activeTab === 'myevents') {
                setTabActive(myEventsTab);
                if (myEvents) myEvents.classList.remove('hidden');
            } else if (activeTab === 'past') {
                setTabActive(pastTab);
                if (pastEvents) pastEvents.classList.remove('hidden');
            }

            // Re-filter after switching tabs
            filterEvents();
        }

        upcomingTab.addEventListener('click', () => switchTab('upcoming'));
        pastTab.addEventListener('click', () => switchTab('past'));
        if (myEventsTab) myEventsTab.addEventListener('click', () => switchTab('myevents'));

        // Search & filter functionality
        function filterEvents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const typeFilter = document.getElementById('eventTypeFilter');
            const recurrenceFilter = document.getElementById('recurrenceFilter');
            const selectedType = typeFilter ? typeFilter.value.toLowerCase() : '';
            const selectedRecurrence = recurrenceFilter ? recurrenceFilter.value.toLowerCase() : '';

            // Determine active container
            let activeContainer = upcomingEvents;
            if (upcomingEvents && !upcomingEvents.classList.contains('hidden')) {
                activeContainer = upcomingEvents;
            } else if (myEvents && !myEvents.classList.contains('hidden')) {
                activeContainer = myEvents;
            } else if (pastEvents && !pastEvents.classList.contains('hidden')) {
                activeContainer = pastEvents;
            }
            
            if (!activeContainer) return;
            const cards = activeContainer.querySelectorAll('.event-card');
            
            cards.forEach(card => {
                const name = card.getAttribute('data-name') || '';
                const description = card.getAttribute('data-description') || '';
                const location = card.getAttribute('data-location') || '';
                const type = card.getAttribute('data-type') || '';
                const recurrence = card.getAttribute('data-recurrence') || '';
                
                const matchesSearch = !searchTerm || 
                    name.includes(searchTerm) || 
                    description.includes(searchTerm) || 
                    location.includes(searchTerm);

                const matchesType = !selectedType || type === selectedType;
                const matchesRecurrence = !selectedRecurrence || recurrence === selectedRecurrence;

                if (matchesSearch && matchesType && matchesRecurrence) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        document.getElementById('searchInput').addEventListener('input', filterEvents);
        const typeFilterEl = document.getElementById('eventTypeFilter');
        const recurrenceFilterEl = document.getElementById('recurrenceFilter');
        if (typeFilterEl) typeFilterEl.addEventListener('change', filterEvents);
        if (recurrenceFilterEl) recurrenceFilterEl.addEventListener('change', filterEvents);

        // Sort functionality
        function sortEvents() {
            const sortOrder = document.getElementById('sortOrder').value;
            const activeContainer = upcomingEvents.classList.contains('hidden') ? pastEvents : upcomingEvents;
            const cards = Array.from(activeContainer.querySelectorAll('.event-card'));
            
            cards.sort((a, b) => {
                const dateA = parseInt(a.getAttribute('data-start-date') || '0');
                const dateB = parseInt(b.getAttribute('data-start-date') || '0');
                
                if (sortOrder === 'asc') {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            });
            
            // Re-append sorted cards
            cards.forEach(card => {
                activeContainer.appendChild(card);
            });
            
            // Re-apply filters after sorting
            filterEvents();
        }

        const sortOrderEl = document.getElementById('sortOrder');
        if (sortOrderEl) {
            sortOrderEl.addEventListener('change', sortEvents);
        }

        // Initialize tab based on URL parameter
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab === 'past') {
                switchTab('past');
            } else if (tab === 'myevents' && myEventsTab) {
                switchTab('myevents');
            } else {
                switchTab('upcoming');
            }
            filterEvents();
        });

        // Auto-hide events success message
        const eventsSuccessMessage = document.getElementById('eventsSuccessMessage');
        if (eventsSuccessMessage) {
            setTimeout(() => {
                eventsSuccessMessage.style.transition = 'opacity 0.5s';
                eventsSuccessMessage.style.opacity = '0';
                setTimeout(() => {
                    eventsSuccessMessage.remove();
                }, 500);
            }, 5000);
        }

        // Registration / Cancellation modal (reuse profile style)
        const registerButtons = document.querySelectorAll('.register-btn');

        // Create modal lazily to avoid duplicating markup
        let modalElement = null;
        let modalTitleEl = null;
        let modalBodyEl = null;
        let modalCancelBtn = null;
        let modalConfirmBtn = null;
        let modalForm = null;

        function ensureModal() {
            if (modalElement) return;

            modalElement = document.createElement('div');
            modalElement.id = 'eventsRegisterModal';
            modalElement.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm';
            modalElement.innerHTML = `
                <div class="bg-card rounded-lg border border-border shadow-lg max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check-2 text-primary">
                                    <path d="M8 2v4"></path>
                                    <path d="M16 2v4"></path>
                                    <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                    <path d="M3 10h18"></path>
                                    <path d="m9 16 2 2 4-4"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 id="eventsModalTitle" class="text-lg font-semibold text-card-foreground"></h3>
                                <p id="eventsModalSubtitle" class="text-sm text-muted-foreground mt-1"></p>
                            </div>
                        </div>
                        <div class="mb-6">
                            <p id="eventsModalBody" class="text-sm text-card-foreground"></p>
                        </div>
                        <div class="flex gap-3 justify-end">
                            <button id="eventsModalCancelBtn" type="button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                Cancel
                            </button>
                            <form id="eventsModalForm" method="POST">
                                <input type="hidden" name="returnTab" id="eventsReturnTabInput" value="upcoming" />
                                <button id="eventsModalConfirmBtn" type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                    Confirm
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modalElement);

            modalTitleEl = document.getElementById('eventsModalTitle');
            modalBodyEl = document.getElementById('eventsModalBody');
            modalCancelBtn = document.getElementById('eventsModalCancelBtn');
            modalConfirmBtn = document.getElementById('eventsModalConfirmBtn');
            modalForm = document.getElementById('eventsModalForm');

            const modalSubtitleEl = document.getElementById('eventsModalSubtitle');

            // Close handlers
            modalCancelBtn.addEventListener('click', () => {
                modalElement.classList.add('hidden');
            });
            modalElement.addEventListener('click', (e) => {
                if (e.target === modalElement) {
                    modalElement.classList.add('hidden');
                }
            });

            // Store subtitle element for later use
            modalElement._subtitleEl = modalSubtitleEl;
        }

        function handleRegisterButtonClick(btn) {
            btn.addEventListener('click', () => {
                ensureModal();
                const sessionId = btn.getAttribute('data-session-id');
                const sessionName = btn.getAttribute('data-session-name') || 'this event';
                const action = btn.getAttribute('data-action');
                const returnTab = btn.getAttribute('data-return-tab') || 'upcoming';

                const subtitleEl = modalElement._subtitleEl;

                if (action === 'cancel') {
                    modalTitleEl.textContent = 'Cancel Registration';
                    if (subtitleEl) subtitleEl.textContent = 'Confirm cancellation';
                    modalBodyEl.textContent = `Are you sure you want to cancel your registration for "${sessionName}"?`;
                    modalForm.action = `/events/${encodeURIComponent(sessionId)}/cancel-registration`;
                    modalConfirmBtn.textContent = 'Confirm Cancellation';
                    modalConfirmBtn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90');
                    modalConfirmBtn.classList.add('border', 'border-destructive', 'text-destructive', 'hover:bg-destructive', 'hover:text-destructive-foreground');
                } else {
                    modalTitleEl.textContent = 'Register for Event';
                    if (subtitleEl) subtitleEl.textContent = 'Confirm your registration';
                    modalBodyEl.textContent = `Do you want to register for "${sessionName}"?`;
                    modalForm.action = `/events/${encodeURIComponent(sessionId)}/register`;
                    modalConfirmBtn.textContent = 'Confirm Registration';
                    modalConfirmBtn.classList.remove('border', 'border-destructive', 'text-destructive', 'hover:bg-destructive', 'hover:text-destructive-foreground');
                    modalConfirmBtn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90');
                }

                const returnInput = document.getElementById('eventsReturnTabInput');
                if (returnInput) {
                    returnInput.value = returnTab;
                }

                modalElement.classList.remove('hidden');
                modalElement.classList.add('flex');
            });
        }

        registerButtons.forEach(handleRegisterButtonClick);

        // Allow other pages (like event-details) to trigger this modal
        window.addEventListener('events-register-click', (e) => {
            const detail = e.detail || {};
            ensureModal();

            const sessionId = detail.sessionId;
            const sessionName = detail.sessionName || 'this event';
            const action = detail.action || 'register';
            const returnTab = detail.returnTab || 'upcoming';

            const subtitleEl = modalElement._subtitleEl;

            if (action === 'cancel') {
                modalTitleEl.textContent = 'Cancel Registration';
                if (subtitleEl) subtitleEl.textContent = 'Confirm cancellation';
                modalBodyEl.textContent = `Are you sure you want to cancel your registration for "${sessionName}"?`;
                modalForm.action = `/events/${encodeURIComponent(sessionId)}/cancel-registration`;
                modalConfirmBtn.textContent = 'Confirm Cancellation';
                modalConfirmBtn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90');
                modalConfirmBtn.classList.add('border', 'border-destructive', 'text-destructive', 'hover:bg-destructive', 'hover:text-destructive-foreground');
            } else {
                modalTitleEl.textContent = 'Register for Event';
                if (subtitleEl) subtitleEl.textContent = 'Confirm your registration';
                modalBodyEl.textContent = `Do you want to register for "${sessionName}"?`;
                modalForm.action = `/events/${encodeURIComponent(sessionId)}/register`;
                modalConfirmBtn.textContent = 'Confirm Registration';
                modalConfirmBtn.classList.remove('border', 'border-destructive', 'text-destructive', 'hover:bg-destructive', 'hover:text-destructive-foreground');
                modalConfirmBtn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90');
            }

            const returnInput = document.getElementById('eventsReturnTabInput');
            if (returnInput) {
                returnInput.value = returnTab;
            }

            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex');
        });
    </script>
</body>
</html>
