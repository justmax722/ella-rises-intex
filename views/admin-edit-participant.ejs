<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Page metadata -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Participant - Ella Rises CRM</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background min-h-screen flex">
    <!-- Sidebar navigation (manager only) -->
    <%- include('partials/sidebar', { user: user, currentPage: 'participants' }) %>

    <!-- Main content area -->
    <main class="flex-1 p-6 overflow-auto">
        <div class="space-y-6">
            <!-- Page header with title and cancel button -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-primary">Edit Participant Profile</h1>
                    <p class="text-muted-foreground mt-1">Update participant profile details</p>
                </div>
                <a href="/participants" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Cancel
                </a>
            </div>

            <!-- Error message display -->
            <% if (typeof query !== 'undefined' && query.error) { %>
            <div class="p-4 bg-destructive/10 border border-destructive/20 rounded-md">
                <p class="text-sm text-destructive">
                    <% if (query.error === 'missing_fields') { %>
                        Please fill in all required fields.
                    <% } else if (query.error === 'invalid_date') { %>
                        Invalid date selected. Please check your date of birth.
                    <% } else { %>
                        An error occurred. Please try again.
                    <% } %>
                </p>
            </div>
            <% } %>

            <!-- Edit participant form -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <!-- Form for updating participant profile information -->
                    <form action="/participants/edit/<%= participant.userid %>" method="POST" class="space-y-4">
                        <!-- Date of birth fields (month, day, year) -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Date of Birth</label>
                            <input type="hidden" id="profiledob" name="profiledob" />
                            <div class="grid grid-cols-3 gap-4 w-full">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="dob_month">Month</label>
                                    <select 
                                        id="dob_month" 
                                        name="dob_month" 
                                        required
                                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                    >
                                        <option value="">Month</option>
                                        <% for (let i = 1; i <= 12; i++) { %>
                                        <option value="<%= i %>" <%= profileData && profileData.profiledob ? (new Date(profileData.profiledob).getMonth() + 1 === i ? 'selected' : '') : '' %>><%= i %></option>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="dob_day">Day</label>
                                    <select 
                                        id="dob_day" 
                                        name="dob_day" 
                                        required
                                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                    >
                                        <option value="">Day</option>
                                        <% for (let i = 1; i <= 31; i++) { %>
                                        <option value="<%= i %>" <%= profileData && profileData.profiledob ? (new Date(profileData.profiledob).getDate() === i ? 'selected' : '') : '' %>><%= i %></option>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="dob_year">Year</label>
                                    <select 
                                        id="dob_year" 
                                        name="dob_year" 
                                        required
                                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                    >
                                        <option value="">Year</option>
                                        <% const currentYear = new Date().getFullYear(); %>
                                        <% for (let i = currentYear; i >= 1900; i--) { %>
                                        <option value="<%= i %>" <%= profileData && profileData.profiledob ? (new Date(profileData.profiledob).getFullYear() === i ? 'selected' : '') : '' %>><%= i %></option>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Phone Number -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilephone">Phone Number</label>
                            <input 
                                type="tel" 
                                id="profilephone" 
                                name="profilephone" 
                                value="<%= profileData ? (profileData.profilephone || '') : '' %>"
                                required
                                placeholder="(555) 123-4567"
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- City -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilecity">City</label>
                            <input 
                                type="text" 
                                id="profilecity" 
                                name="profilecity" 
                                value="<%= profileData ? (profileData.profilecity || '') : '' %>"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- State -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilestate">State</label>
                            <input 
                                type="text" 
                                id="profilestate" 
                                name="profilestate" 
                                value="<%= profileData ? (profileData.profilestate || '') : '' %>"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- Zip Code -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilezip">Zip Code</label>
                            <input 
                                type="text" 
                                id="profilezip" 
                                name="profilezip" 
                                value="<%= profileData ? (profileData.profilezip || '') : '' %>"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- School/Employer -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profileschooloremployer">School/Employer</label>
                            <input 
                                type="text" 
                                id="profileschooloremployer" 
                                name="profileschooloremployer" 
                                value="<%= profileData ? (profileData.profileschooloremployer || '') : '' %>"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- Field of Interest -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilefieldofinterest">Field of Interest</label>
                            <input 
                                type="text" 
                                id="profilefieldofinterest" 
                                name="profilefieldofinterest" 
                                value="<%= profileData ? (profileData.profilefieldofinterest || '') : '' %>"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- Submit Button -->
                        <div class="flex gap-4 pt-4">
                            <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                Save Changes
                            </button>
                            <a href="/participants" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Update hidden date field when date selects change
        const dobMonth = document.getElementById('dob_month');
        const dobDay = document.getElementById('dob_day');
        const dobYear = document.getElementById('dob_year');
        const dobHidden = document.getElementById('profiledob');

        function updateHiddenDate() {
            if (dobMonth.value && dobDay.value && dobYear.value) {
                const month = String(dobMonth.value).padStart(2, '0');
                const day = String(dobDay.value).padStart(2, '0');
                const year = dobYear.value;
                dobHidden.value = `${year}-${month}-${day}`;
            }
        }

        if (dobMonth) dobMonth.addEventListener('change', updateHiddenDate);
        if (dobDay) dobDay.addEventListener('change', updateHiddenDate);
        if (dobYear) dobYear.addEventListener('change', updateHiddenDate);

        // Phone number formatting: (XXX) XXX-XXXX
        const phoneInput = document.getElementById('profilephone');
        if (phoneInput) {
            // Format existing value if present
            if (phoneInput.value) {
                let value = phoneInput.value.replace(/\D/g, '');
                if (value.length === 10) {
                    phoneInput.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                }
            }

            phoneInput.addEventListener('input', function(e) {
                // Remove all non-digit characters
                let value = e.target.value.replace(/\D/g, '');
                
                // Limit to 10 digits
                if (value.length > 10) {
                    value = value.slice(0, 10);
                }
                
                // Format as (XXX) XXX-XXXX
                if (value.length > 0) {
                    if (value.length <= 3) {
                        e.target.value = `(${value}`;
                    } else if (value.length <= 6) {
                        e.target.value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                    } else {
                        e.target.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                    }
                } else {
                    e.target.value = '';
                }
            });

            // Prevent non-numeric input
            phoneInput.addEventListener('keypress', function(e) {
                if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        }
    </script>
</body>
</html>

