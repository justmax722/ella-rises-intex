<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - Ella Rises CRM</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background min-h-screen flex">
    <!-- Sidebar Navigation -->
    <%- include('partials/sidebar', { user: user, currentPage: 'events' }) %>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 overflow-auto">
        <div class="space-y-6">
            <!-- Page Header -->
            <div class="space-y-4">
                <!-- Title Row -->
                <div>
                    <h1 class="text-3xl font-serif font-bold text-primary"><%= session.eventname %></h1>
                    <p class="text-muted-foreground mt-1">Event session details</p>
                </div>

                <!-- Actions Row -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <!-- Back to Events Link -->
                        <a href="/events?tab=<%= (typeof query !== 'undefined' && query.from === 'past') ? 'past' : 'upcoming' %>" class="inline-flex items-center gap-2 text-muted-foreground hover:text-foreground">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left h-4 w-4">
                                <path d="m12 19-7-7 7-7"></path>
                                <path d="M19 12H5"></path>
                            </svg>
                            <span>Back to Events</span>
                        </a>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
                        <% if (user.role === 'manager') { %>
                            <a href="/events/<%= session.sessionid %>/attendance" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                Take Attendance
                            </a>
                            <a href="/events/<%= session.sessionid %>/edit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                Edit
                            </a>
                            <button type="button" id="deleteEventBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground h-10 px-4 py-2" data-session-id="<%= session.sessionid %>" data-session-name="<%= session.eventname %>">
                                Delete
                            </button>
                        <% } %>

                        <% if (user.role === 'user') { %>
                            <% 
                                const deadlinePassed = registrationDeadlinePassed;
                                const isCancelled = registrationStatus === 'cancelled';
                                const full = !!isFull;
                                const showRegister = !deadlinePassed && !full && (!isRegistered || isCancelled);
                                const showCancel = !deadlinePassed && isRegistered && !isCancelled;
                                const returnTab = (typeof query !== 'undefined' && query.from === 'past') ? 'past' : 'upcoming';
                            %>
                            <% if (deadlinePassed) { %>
                                <button 
                                    type="button"
                                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 cursor-not-allowed bg-muted text-muted-foreground"
                                    aria-disabled="true"
                                >
                                    Registration Has Passed
                                </button>
                            <% } else if (showRegister) { %>
                                <button 
                                    type="button"
                                    class="details-register-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90"
                                    data-session-id="<%= session.sessionid %>"
                                    data-session-name="<%= session.eventname %>"
                                    data-action="register"
                                    data-return-tab="<%= returnTab %>"
                                >
                                    Register
                                </button>
                            <% } else if (showCancel) { %>
                                <button 
                                    type="button"
                                    class="details-register-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground"
                                    data-session-id="<%= session.sessionid %>"
                                    data-session-name="<%= session.eventname %>"
                                    data-action="cancel"
                                    data-return-tab="<%= returnTab %>"
                                >
                                    Cancel Registration
                                </button>
                            <% } else if (full) { %>
                                <button 
                                    type="button"
                                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 cursor-not-allowed bg-muted text-muted-foreground"
                                    aria-disabled="true"
                                >
                                    No Seats Available
                                </button>
                            <% } %>
                        <% } %>
                    </div>
                </div>

                <!-- Success Message -->
                <% if (typeof query !== 'undefined' && query.success === 'true') { %>
                <div id="successMessage" class="p-4 rounded-md shadow-sm" style="background-color: #80d8a1; border: 1px solid #7bdfa0;">
                    <p class="text-sm font-medium text-white">Event created successfully!</p>
                </div>
                <% } %>
            </div>

            <!-- Event Details -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <!-- Event Information Section -->
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-border">Event Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Event Name</label>
                                <p class="mt-1 text-sm font-medium"><%= session.eventname %></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Event Type</label>
                                <p class="mt-1 text-sm font-medium">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent text-accent-foreground"><%= session.eventtype %></span>
                                </p>
                            </div>
                            <% if (session.eventdescription) { %>
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium text-muted-foreground">Description</label>
                                <p class="mt-1 text-sm font-medium"><%= session.eventdescription %></p>
                            </div>
                            <% } %>
                            <% if (session.eventrecurrencepattern) { %>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Recurrence Pattern</label>
                                <p class="mt-1 text-sm font-medium"><%= session.eventrecurrencepattern %></p>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Session Information Section -->
                    <div>
                        <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-border">Session Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Start Date & Time</label>
                                <% 
                                    const startDate = new Date(session.eventdatetimestart);
                                    const formattedStartDate = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                    const formattedStartTime = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                %>
                                <p class="mt-1 text-sm font-medium"><%= formattedStartDate %> at <%= formattedStartTime %></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">End Date & Time</label>
                                <% 
                                    const endDate = new Date(session.eventdatetimeend);
                                    const formattedEndDate = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                    const formattedEndTime = endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                %>
                                <p class="mt-1 text-sm font-medium"><%= formattedEndDate %> at <%= formattedEndTime %></p>
                            </div>
                            <% if (session.eventlocation) { %>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Location</label>
                                <p class="mt-1 text-sm font-medium"><%= session.eventlocation %></p>
                            </div>
                            <% } %>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Capacity</label>
                                <p class="mt-1 text-sm font-medium"><%= capacity %></p>
                            </div>
                            <% if (session.eventregistrationdeadline) { %>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Registration Deadline</label>
                                <% 
                                    const regDeadline = new Date(session.eventregistrationdeadline);
                                    const formattedRegDate = regDeadline.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                    const formattedRegTime = regDeadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                %>
                                <p class="mt-1 text-sm font-medium"><%= formattedRegDate %> at <%= formattedRegTime %></p>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Event Statistics -->
                    <div class="mt-12">
                        <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-border">Event Statistics</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Registration Count (always show) -->
                        <div class="p-4 rounded-lg border bg-muted/20">
                            <p class="text-sm text-muted-foreground">Registrations</p>
                            <p class="text-2xl font-semibold text-card-foreground mt-1"><%= (registrationCount ?? currentRegistrationCount ?? 0).toLocaleString('en-US') %></p>
                            <p class="text-xs text-muted-foreground mt-1">Total registered participants</p>
                        </div>

                        <% if (eventEnded) { %>
                        <!-- Attendees -->
                        <div class="p-4 rounded-lg border bg-muted/20">
                            <p class="text-sm text-muted-foreground">Attendees</p>
                            <p class="text-2xl font-semibold text-card-foreground mt-1"><%= attendeeCount !== undefined ? attendeeCount.toLocaleString('en-US') : '0' %></p>
                            <p class="text-xs text-muted-foreground mt-1">Marked as attended</p>
                        </div>

                        <!-- Attendance Rate -->
                        <div class="p-4 rounded-lg border bg-muted/20">
                            <p class="text-sm text-muted-foreground">Attendance Rate</p>
                            <p class="text-2xl font-semibold text-card-foreground mt-1">
                                <%= attendanceRate !== null && attendanceRate !== undefined ? `${attendanceRate}%` : 'N/A' %>
                            </p>
                            <p class="text-xs text-muted-foreground mt-1">Attendees / Registered</p>
                        </div>

                        <!-- Overall Survey Average -->
                        <div class="p-4 rounded-lg border bg-muted/20">
                            <p class="text-sm text-muted-foreground">Overall Survey Score</p>
                            <p class="text-2xl font-semibold text-card-foreground mt-1">
                                <%= overallSurveyAverage !== null && overallSurveyAverage !== undefined ? overallSurveyAverage : 'N/A' %>
                            </p>
                            <p class="text-xs text-muted-foreground mt-1">Average of overall scores</p>
                        </div>

                        <!-- Per-question averages -->
                        <div class="p-4 rounded-lg border bg-muted/20 md:col-span-2">
                            <p class="text-sm font-medium text-card-foreground mb-3">Average by Question</p>
                            <% if (metricAverages && metricAverages.length > 0) { %>
                                <div class="space-y-2">
                                    <% metricAverages.forEach((metric, idx) => { %>
                                        <div class="flex items-center justify-between p-3 rounded-md bg-card shadow-sm">
                                            <div class="flex items-center gap-3">
                                                <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-primary/10 text-xs font-semibold text-primary">Q<%= idx + 1 %></span>
                                                <span class="text-sm text-card-foreground"><%= metric.metricQuestion || metric.metricName || ('Question ' + (idx + 1)) %></span>
                                            </div>
                                            <span class="text-sm font-semibold text-card-foreground"><%= metric.averageScore !== null ? metric.averageScore : 'N/A' %></span>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <p class="text-sm text-muted-foreground">No survey responses yet.</p>
                            <% } %>
                        </div>
                        <% } else { %>
                            <div class="p-4 rounded-lg border bg-muted/20">
                                <p class="text-sm text-muted-foreground">Survey and attendance stats will be available after the event ends.</p>
                            </div>
                        <% } %>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </main>

    <script>
        // Auto-hide success message
        const successMessage = document.getElementById('successMessage');
        if (successMessage) {
            setTimeout(() => {
                successMessage.style.transition = 'opacity 0.5s';
                successMessage.style.opacity = '0';
                setTimeout(() => {
                    successMessage.remove();
                }, 500);
            }, 5000);
        }

        // Registration / Cancellation modal specifically for the details page
        document.addEventListener('DOMContentLoaded', () => {
            const detailButtons = document.querySelectorAll('.details-register-btn');
            if (!detailButtons.length) return;

            let modalElement = null;
            let modalTitleEl = null;
            let modalBodyEl = null;
            let modalCancelBtn = null;
            let modalConfirmBtn = null;
            let modalForm = null;

            function ensureModal() {
                if (modalElement) return;

                modalElement = document.createElement('div');
                modalElement.id = 'eventDetailsRegisterModal';
                modalElement.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm';
                modalElement.innerHTML = `
                    <div class="bg-card rounded-lg border border-border shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check-2 text-primary">
                                        <path d="M8 2v4"></path>
                                        <path d="M16 2v4"></path>
                                        <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                        <path d="M3 10h18"></path>
                                        <path d="m9 16 2 2 4-4"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 id="eventDetailsModalTitle" class="text-lg font-semibold text-card-foreground"></h3>
                                    <p id="eventDetailsModalSubtitle" class="text-sm text-muted-foreground mt-1"></p>
                                </div>
                            </div>
                            <div class="mb-6">
                                <p id="eventDetailsModalBody" class="text-sm text-card-foreground"></p>
                            </div>
                            <div class="flex gap-3 justify-end">
                                <button id="eventDetailsModalCancelBtn" type="button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                    Cancel
                                </button>
                                <form id="eventDetailsModalForm" method="POST">
                                    <input type="hidden" name="returnTab" id="eventDetailsReturnTabInput" value="upcoming" />
                                    <button id="eventDetailsModalConfirmBtn" type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                        Confirm
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modalElement);

                modalTitleEl = document.getElementById('eventDetailsModalTitle');
                modalBodyEl = document.getElementById('eventDetailsModalBody');
                modalCancelBtn = document.getElementById('eventDetailsModalCancelBtn');
                modalConfirmBtn = document.getElementById('eventDetailsModalConfirmBtn');
                modalForm = document.getElementById('eventDetailsModalForm');

                const modalSubtitleEl = document.getElementById('eventDetailsModalSubtitle');
                modalElement._subtitleEl = modalSubtitleEl;

                modalCancelBtn.addEventListener('click', () => {
                    modalElement.classList.add('hidden');
                });
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        modalElement.classList.add('hidden');
                    }
                });
            }

            detailButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    ensureModal();

                    const sessionId = btn.getAttribute('data-session-id');
                    const sessionName = btn.getAttribute('data-session-name') || 'this event';
                    const action = btn.getAttribute('data-action');
                    const returnTab = btn.getAttribute('data-return-tab') || 'upcoming';

                    const subtitleEl = modalElement._subtitleEl;

                    if (action === 'cancel') {
                        modalTitleEl.textContent = 'Cancel Registration';
                        if (subtitleEl) subtitleEl.textContent = 'Confirm cancellation';
                        modalBodyEl.textContent = `Are you sure you want to cancel your registration for "${sessionName}"?`;
                        modalForm.action = `/events/${encodeURIComponent(sessionId)}/cancel-registration`;
                        modalConfirmBtn.textContent = 'Confirm Cancellation';
                        modalConfirmBtn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90');
                        modalConfirmBtn.classList.add('border', 'border-destructive', 'text-destructive', 'hover:bg-destructive', 'hover:text-destructive-foreground');
                    } else {
                        modalTitleEl.textContent = 'Register for Event';
                        if (subtitleEl) subtitleEl.textContent = 'Confirm your registration';
                        modalBodyEl.textContent = `Do you want to register for "${sessionName}"?`;
                        modalForm.action = `/events/${encodeURIComponent(sessionId)}/register`;
                        modalConfirmBtn.textContent = 'Confirm Registration';
                        modalConfirmBtn.classList.remove('border', 'border-destructive', 'text-destructive', 'hover:bg-destructive', 'hover:text-destructive-foreground');
                        modalConfirmBtn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90');
                    }

                    const returnInput = document.getElementById('eventDetailsReturnTabInput');
                    if (returnInput) {
                        returnInput.value = returnTab;
                    }

                    modalElement.classList.remove('hidden');
                    modalElement.classList.add('flex');
                });
            });
        });

        // Delete Event Confirmation Modal
        document.addEventListener('DOMContentLoaded', () => {
            const deleteBtn = document.getElementById('deleteEventBtn');
            if (!deleteBtn) return;

            let deleteModalElement = null;
            let deleteModalTitleEl = null;
            let deleteModalBodyEl = null;
            let deleteModalCancelBtn = null;
            let deleteModalConfirmBtn = null;
            let deleteModalForm = null;

            function ensureDeleteModal() {
                if (deleteModalElement) return;

                deleteModalElement = document.createElement('div');
                deleteModalElement.id = 'deleteEventModal';
                deleteModalElement.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm';
                deleteModalElement.innerHTML = `
                    <div class="bg-card rounded-lg border border-border shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-destructive">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 id="deleteEventModalTitle" class="text-lg font-semibold text-card-foreground"></h3>
                                    <p id="deleteEventModalSubtitle" class="text-sm text-muted-foreground mt-1">Confirm deletion</p>
                                </div>
                            </div>
                            <div class="mb-6">
                                <p id="deleteEventModalBody" class="text-sm text-card-foreground"></p>
                            </div>
                            <div class="flex gap-3 justify-end">
                                <button id="deleteEventModalCancelBtn" type="button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                    Cancel
                                </button>
                                <form id="deleteEventModalForm" method="POST">
                                    <button id="deleteEventModalConfirmBtn" type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground h-10 px-4 py-2">
                                        Delete Event
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(deleteModalElement);

                deleteModalTitleEl = document.getElementById('deleteEventModalTitle');
                deleteModalBodyEl = document.getElementById('deleteEventModalBody');
                deleteModalCancelBtn = document.getElementById('deleteEventModalCancelBtn');
                deleteModalConfirmBtn = document.getElementById('deleteEventModalConfirmBtn');
                deleteModalForm = document.getElementById('deleteEventModalForm');

                deleteModalCancelBtn.addEventListener('click', () => {
                    deleteModalElement.classList.add('hidden');
                });
                deleteModalElement.addEventListener('click', (e) => {
                    if (e.target === deleteModalElement) {
                        deleteModalElement.classList.add('hidden');
                    }
                });
            }

            deleteBtn.addEventListener('click', () => {
                ensureDeleteModal();

                const sessionId = deleteBtn.getAttribute('data-session-id');
                const sessionName = deleteBtn.getAttribute('data-session-name') || 'this event';

                deleteModalTitleEl.textContent = 'Delete Event Session';
                deleteModalBodyEl.textContent = `Are you sure you want to delete "${sessionName}"? This will permanently delete the session and all corresponding registrations. This action cannot be undone.`;
                deleteModalForm.action = `/events/${encodeURIComponent(sessionId)}/delete`;

                deleteModalElement.classList.remove('hidden');
                deleteModalElement.classList.add('flex');
            });
        });
    </script>
</body>
</html>

