<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Ella Rises CRM</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background min-h-screen flex">
    <!-- Sidebar Navigation -->
    <%- include('partials/sidebar', { user: user, currentPage: 'profile' }) %>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 overflow-auto">
        <div class="space-y-6">
            <!-- Page Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-primary">Edit Profile Information</h1>
                    <p class="text-muted-foreground mt-1">Update your profile details</p>
                </div>
                <a href="/profile?tab=profile" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Cancel
                </a>
            </div>

            <!-- Error Message -->
            <% if (typeof query !== 'undefined' && query.error) { %>
            <div class="p-4 bg-destructive/10 border border-destructive/20 rounded-md">
                <p class="text-sm text-destructive">
                    <% if (query.error === 'missing_fields') { %>
                        Please fill in all fields.
                    <% } else if (query.error === 'invalid_date') { %>
                        Invalid date selected. Please check your date of birth.
                    <% } else { %>
                        An error occurred. Please try again.
                    <% } %>
                </p>
            </div>
            <% } %>

            <!-- Edit Form -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm max-w-2xl mx-auto">
                <div class="p-6">
                    <form action="/profile/edit?type=profile" method="POST" class="space-y-4">
                        <!-- Date of Birth - Month, Day, Year inline -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Date of Birth</label>
                            <div class="flex gap-3">
                                <select 
                                    id="dob_month" 
                                    name="dob_month" 
                                    required
                                    class="w-32 h-10 rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                >
                                    <option value="">Month</option>
                                    <% 
                                    let selectedMonth = '';
                                    if (profileData && profileData.profiledob) {
                                        selectedMonth = String(new Date(profileData.profiledob).getMonth() + 1).padStart(2, '0');
                                    }
                                    %>
                                    <option value="01" <%= selectedMonth === '01' ? 'selected' : '' %>>January</option>
                                    <option value="02" <%= selectedMonth === '02' ? 'selected' : '' %>>February</option>
                                    <option value="03" <%= selectedMonth === '03' ? 'selected' : '' %>>March</option>
                                    <option value="04" <%= selectedMonth === '04' ? 'selected' : '' %>>April</option>
                                    <option value="05" <%= selectedMonth === '05' ? 'selected' : '' %>>May</option>
                                    <option value="06" <%= selectedMonth === '06' ? 'selected' : '' %>>June</option>
                                    <option value="07" <%= selectedMonth === '07' ? 'selected' : '' %>>July</option>
                                    <option value="08" <%= selectedMonth === '08' ? 'selected' : '' %>>August</option>
                                    <option value="09" <%= selectedMonth === '09' ? 'selected' : '' %>>September</option>
                                    <option value="10" <%= selectedMonth === '10' ? 'selected' : '' %>>October</option>
                                    <option value="11" <%= selectedMonth === '11' ? 'selected' : '' %>>November</option>
                                    <option value="12" <%= selectedMonth === '12' ? 'selected' : '' %>>December</option>
                                </select>
                                <select 
                                    id="dob_day" 
                                    name="dob_day" 
                                    required
                                    class="w-20 h-10 rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                >
                                    <option value="">Day</option>
                                </select>
                                <select 
                                    id="dob_year" 
                                    name="dob_year" 
                                    required
                                    class="w-24 h-10 rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                >
                                    <option value="">Year</option>
                                </select>
                            </div>
                            <input type="hidden" id="profiledob" name="profiledob" required />
                        </div>

                        <!-- Phone Number -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilephone">Phone Number</label>
                            <input 
                                type="tel" 
                                id="profilephone" 
                                name="profilephone" 
                                value="<%= profileData ? (profileData.profilephone || '') : '' %>"
                                required
                                placeholder="(555) 123-4567"
                                maxlength="14"
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- City -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilecity">City</label>
                            <input 
                                type="text" 
                                id="profilecity" 
                                name="profilecity" 
                                value="<%= profileData ? (profileData.profilecity || '') : '' %>"
                                required
                                placeholder="New York"
                                maxlength="100"
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- State and Zip Code -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilestate">State</label>
                                <input 
                                    type="text" 
                                    id="profilestate" 
                                    name="profilestate" 
                                    value="<%= profileData ? (profileData.profilestate || '') : '' %>"
                                    required
                                    placeholder="NY"
                                    maxlength="50"
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                />
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profilezip">Zip Code</label>
                                <input 
                                    type="text" 
                                    id="profilezip" 
                                    name="profilezip" 
                                    value="<%= profileData ? (profileData.profilezip || '') : '' %>"
                                    required
                                    placeholder="10001"
                                    maxlength="20"
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                                />
                            </div>
                        </div>

                        <!-- School/Employer -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="profileschooloremployer">School or Employer</label>
                            <input 
                                type="text" 
                                id="profileschooloremployer" 
                                name="profileschooloremployer" 
                                value="<%= profileData ? (profileData.profileschooloremployer || '') : '' %>"
                                required
                                placeholder="ABC University or XYZ Company"
                                maxlength="200"
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"
                            />
                        </div>

                        <!-- Field of Interest -->
                        <div class="space-y-3">
                            <label class="text-sm font-medium leading-none">Field of Interest</label>
                            <div class="flex gap-3">
                                <label class="flex-1 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        name="profilefieldofinterest" 
                                        value="STEM"
                                        required
                                        <%= profileData && profileData.profilefieldofinterest === 'STEM' ? 'checked' : '' %>
                                        class="peer hidden"
                                    />
                                    <div class="flex items-center justify-center h-10 px-4 rounded-md border border-input bg-background text-sm font-medium transition-all peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary hover:bg-muted/50">
                                        STEM
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        name="profilefieldofinterest" 
                                        value="Arts"
                                        <%= profileData && profileData.profilefieldofinterest === 'Arts' ? 'checked' : '' %>
                                        class="peer hidden"
                                    />
                                    <div class="flex items-center justify-center h-10 px-4 rounded-md border border-input bg-background text-sm font-medium transition-all peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary hover:bg-muted/50">
                                        Arts
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        name="profilefieldofinterest" 
                                        value="Both"
                                        <%= profileData && profileData.profilefieldofinterest === 'Both' ? 'checked' : '' %>
                                        class="peer hidden"
                                    />
                                    <div class="flex items-center justify-center h-10 px-4 rounded-md border border-input bg-background text-sm font-medium transition-all peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary hover:bg-muted/50">
                                        Both
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex gap-4 pt-4">
                            <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 text-white h-10 px-4 py-2" style="background-color: #49db7f !important;" onmouseover="this.style.backgroundColor='#15803d'" onmouseout="this.style.backgroundColor='#49db7f'">
                                Save Changes
                            </button>
                            <a href="/profile?tab=profile" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Populate year dropdown (from current year back to 100 years ago)
        const yearSelect = document.getElementById('dob_year');
        const currentYear = new Date().getFullYear();
        <% if (profileData && profileData.profiledob) { %>
        const existingDate = new Date('<%= profileData.profiledob %>');
        const existingYear = existingDate.getFullYear();
        const existingMonth = String(existingDate.getMonth() + 1).padStart(2, '0');
        const existingDay = String(existingDate.getDate()).padStart(2, '0');
        <% } else { %>
        const existingYear = null;
        const existingMonth = null;
        const existingDay = null;
        <% } %>
        
        for (let year = currentYear; year >= currentYear - 100; year--) {
            const option = document.createElement('option');
            option.value = year.toString();
            option.textContent = year.toString();
            <% if (profileData && profileData.profiledob) { %>
            if (year === existingYear) {
                option.selected = true;
            }
            <% } %>
            yearSelect.appendChild(option);
        }

        // Populate day dropdown - show all 31 days initially
        const monthSelect = document.getElementById('dob_month');
        const daySelect = document.getElementById('dob_day');
        const dobHidden = document.getElementById('profiledob');

        // Initialize with all 31 days
        function initializeDays() {
            daySelect.innerHTML = '<option value="">Day</option>';
            <% if (profileData && profileData.profiledob) { %>
            const daysInMonth = existingMonth && existingYear ? new Date(parseInt(existingYear), parseInt(existingMonth), 0).getDate() : 31;
            <% } else { %>
            const daysInMonth = 31;
            <% } %>
            for (let day = 1; day <= daysInMonth; day++) {
                const option = document.createElement('option');
                option.value = day.toString().padStart(2, '0');
                option.textContent = day.toString();
                <% if (profileData && profileData.profiledob) { %>
                if (existingDay && parseInt(existingDay) === day) {
                    option.selected = true;
                }
                <% } %>
                daySelect.appendChild(option);
            }
        }

        // Initialize hidden date field if existing date is present
        <% if (profileData && profileData.profiledob) { %>
        if (existingMonth && existingDay && existingYear) {
            dobHidden.value = `${existingYear}-${existingMonth}-${existingDay}`;
        }
        <% } %>

        // Update day dropdown when month/year changes to show valid days
        function updateDays() {
            const month = monthSelect.value;
            const year = yearSelect.value;
            
            // If both month and year are selected, limit to valid days
            if (month && year) {
                // Get number of days in the selected month (handles leap years)
                const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                
                // Save currently selected day
                const selectedDay = daySelect.value;
                
                // Rebuild day options
                daySelect.innerHTML = '<option value="">Day</option>';
                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement('option');
                    option.value = day.toString().padStart(2, '0');
                    option.textContent = day.toString();
                    // Restore selection if it's still valid
                    if (selectedDay && parseInt(selectedDay) === day) {
                        option.selected = true;
                    }
                    daySelect.appendChild(option);
                }
            } else {
                // If month/year not selected, show all 31 days
                initializeDays();
            }
        }

        function updateHiddenDate() {
            const month = monthSelect.value;
            const day = daySelect.value;
            const year = yearSelect.value;
            
            if (month && day && year) {
                dobHidden.value = `${year}-${month}-${day}`;
            } else {
                dobHidden.value = '';
            }
        }

        // Initialize days on page load
        initializeDays();

        monthSelect.addEventListener('change', function() {
            updateDays();
            updateHiddenDate();
        });

        yearSelect.addEventListener('change', function() {
            updateDays();
            updateHiddenDate();
        });

        daySelect.addEventListener('change', updateHiddenDate);

        // Phone number formatting: (XXX) XXX-XXXX
        const phoneInput = document.getElementById('profilephone');
        if (phoneInput) {
            // Format existing value if present
            if (phoneInput.value) {
                let value = phoneInput.value.replace(/\D/g, '');
                if (value.length === 10) {
                    phoneInput.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                }
            }

            phoneInput.addEventListener('input', function(e) {
                // Remove all non-digit characters
                let value = e.target.value.replace(/\D/g, '');
                
                // Limit to 10 digits
                if (value.length > 10) {
                    value = value.slice(0, 10);
                }
                
                // Format as (XXX) XXX-XXXX
                if (value.length > 0) {
                    if (value.length <= 3) {
                        e.target.value = `(${value}`;
                    } else if (value.length <= 6) {
                        e.target.value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                    } else {
                        e.target.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                    }
                } else {
                    e.target.value = '';
                }
            });

            // Prevent non-numeric input
            phoneInput.addEventListener('keypress', function(e) {
                if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        }
    </script>
</body>
</html>

