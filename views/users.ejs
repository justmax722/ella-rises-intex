<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Ella Rises CRM</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background min-h-screen flex">
    <!-- Sidebar Navigation -->
    <%- include('partials/sidebar', { user: user, currentPage: 'users' }) %>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Page Header -->
            <div class="mb-8 flex items-center justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-serif text-foreground mb-2">Users</h1>
                    <p class="text-base text-card-foreground/70">Manage system users and permissions</p>
                </div>
                <% if (user.role === 'manager') { %>
                <a href="/users/add" class="inline-flex items-center px-4 py-2.5 bg-primary text-primary-foreground rounded-md font-medium hover:bg-primary/90 transition-colors">
                    + Add User
                </a>
                <% } %>
            </div>

            <!-- Success/Error Messages -->
            <% if (typeof query !== 'undefined' && query.success) { %>
            <div class="mb-6 p-4 bg-secondary/20 border border-secondary rounded-md">
                <p class="text-sm text-card-foreground text-center">
                    <% if (query.success === 'role_updated') { %>
                        User role updated successfully.
                    <% } else if (query.success === 'user_updated' || query.success === 'user_updated_with_password') { %>
                        User updated successfully.
                    <% } else if (query.success === 'user_deleted') { %>
                        User deleted successfully.
                    <% } %>
                </p>
            </div>
            <% } %>
            <% if (typeof query !== 'undefined' && query.error) { %>
            <div class="mb-6 p-4 bg-destructive/10 border border-destructive/20 rounded-md">
                <p class="text-sm text-destructive text-center">
                    <% if (query.error === 'demo_accounts_cannot_be_modified') { %>
                        Demo accounts cannot be modified.
                    <% } else if (query.error === 'demo_accounts_cannot_be_deleted') { %>
                        Demo accounts cannot be deleted.
                    <% } else if (query.error === 'cannot_delete_yourself') { %>
                        You cannot delete your own account.
                    <% } else if (query.error === 'update_failed') { %>
                        Failed to update user. Please try again.
                    <% } else if (query.error === 'password_too_short') { %>
                        Password must be at least 6 characters long.
                    <% } else if (query.error === 'delete_failed') { %>
                        Failed to delete user. Please try again.
                    <% } %>
                </p>
            </div>
            <% } %>

            <!-- Search and Filters -->
            <div class="mb-6 bg-card rounded-lg shadow-sm p-6">
                <div class="flex items-end gap-4 flex-wrap">
                    <!-- Search -->
                    <div class="flex-1 min-w-[200px]">
                        <label for="searchInput" class="block text-sm font-medium text-card-foreground mb-2">Search</label>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search by name or email..." 
                            class="w-full px-4 py-2 border border-input rounded-md bg-background text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors"
                        />
                    </div>
                    <!-- Role Dropdown -->
                    <div class="min-w-[150px]">
                        <label for="roleFilter" class="block text-sm font-medium text-card-foreground mb-2">Role</label>
                        <select 
                            id="roleFilter" 
                            class="w-full px-4 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors"
                        >
                            <option value="">All Roles</option>
                            <option value="manager">Manager</option>
                            <option value="user">User</option>
                            <option value="donor">Donor</option>
                        </select>
                    </div>
                    <!-- Status Dropdown -->
                    <div class="min-w-[150px]">
                        <label for="statusFilter" class="block text-sm font-medium text-card-foreground mb-2">Status</label>
                        <select 
                            id="statusFilter" 
                            class="w-full px-4 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors"
                        >
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <!-- Clear Button -->
                    <div>
                        <label class="block text-sm font-medium text-card-foreground mb-2 opacity-0 pointer-events-none">Clear</label>
                        <button 
                            type="button" 
                            id="clearFilters" 
                            class="px-4 py-2 border border-input rounded-md text-sm font-medium text-card-foreground hover:bg-muted transition-colors whitespace-nowrap"
                        >
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="bg-card rounded-lg shadow-sm overflow-hidden">
                <div class="p-6 border-b border-border">
                    <h3 class="text-lg font-semibold text-card-foreground">System Users</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-muted/50 border-b border-border">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-card-foreground uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-card-foreground uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-card-foreground uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-card-foreground uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-card-foreground uppercase tracking-wider">Last Login</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-card-foreground uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border" id="usersTableBody">
                            <% if (typeof users !== 'undefined' && users.length > 0) { %>
                                <% users.forEach(function(user) { %>
                                    <tr 
                                        class="user-row hover:bg-muted/30 transition-colors" 
                                        data-userid="<%= user.userid %>"
                                        data-name="<%= (user.firstName + ' ' + user.lastName).toLowerCase() %>"
                                        data-email="<%= user.email.toLowerCase() %>"
                                        data-role="<%= user.role %>"
                                        data-status="<%= user.status %>"
                                    >
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-card-foreground"><%= user.fullName %></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-card-foreground/70"><%= user.email %></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <% if (user.role === 'manager') { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-primary-foreground">manager</span>
                                            <% } else if (user.role === 'user') { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary text-secondary-foreground">user</span>
                                            <% } else if (user.role === 'donor') { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent text-accent-foreground">donor</span>
                                            <% } %>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <% if (user.status === 'active') { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary text-secondary-foreground">active</span>
                                            <% } else { %>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-muted text-muted-foreground">inactive</span>
                                            <% } %>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-card-foreground/70">â€”</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <a href="/users/edit/<%= user.userid %>" class="text-accent hover:text-accent/80 mr-3">Edit</a>
                                            <button 
                                                class="text-destructive hover:text-destructive/80 delete-user-btn"
                                                data-userid="<%= user.userid %>"
                                                data-name="<%= user.fullName %>"
                                                data-email="<%= user.email %>"
                                            >
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-sm text-card-foreground/70">No users found</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-card rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-card-foreground mb-4">Delete User?</h3>
            <p class="text-sm text-card-foreground/70 mb-6">
                Are you sure? This will permanently delete the user's login and profile. Their donation history will be anonymized and cannot be recovered.
            </p>
            <div class="flex gap-3 justify-end">
                <button 
                    id="cancelDeleteBtn"
                    class="px-4 py-2 border border-input rounded-md text-sm font-medium text-card-foreground hover:bg-muted transition-colors"
                >
                    Cancel
                </button>
                <form id="deleteForm" method="POST" action="/users/delete" class="inline">
                    <input type="hidden" id="deleteUserId" name="userid" value="" />
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-destructive text-destructive-foreground rounded-md text-sm font-medium hover:bg-destructive/90 transition-colors"
                    >
                        Yes, Delete
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Filter users based on search and filters
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const rows = document.querySelectorAll('.user-row');
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const email = row.getAttribute('data-email') || '';
                const role = row.getAttribute('data-role') || '';
                const status = row.getAttribute('data-status') || '';
                
                // Search filter (name or email)
                const matchesSearch = !searchTerm || 
                    name.includes(searchTerm) || 
                    email.includes(searchTerm);
                
                // Role filter
                const matchesRole = !roleFilter || roleFilter === role;
                
                // Status filter
                const matchesStatus = !statusFilter || statusFilter === status;
                
                // Show row if all filters match
                if (matchesSearch && matchesRole && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Search input event listener with debounce
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', debounce(filterUsers, 300));
        }

        // Role filter dropdown
        const roleFilter = document.getElementById('roleFilter');
        if (roleFilter) {
            roleFilter.addEventListener('change', filterUsers);
        }

        // Status filter dropdown
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', filterUsers);
        }

        // Clear filters button
        const clearFiltersBtn = document.getElementById('clearFilters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                // Clear search
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // Reset role filter
                if (roleFilter) {
                    roleFilter.value = '';
                }
                
                // Reset status filter
                if (statusFilter) {
                    statusFilter.value = '';
                }
                
                // Re-filter to show all users
                filterUsers();
            });
        }

        // Delete modal functionality
        const deleteModal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');
        const deleteUserIdInput = document.getElementById('deleteUserId');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const deleteButtons = document.querySelectorAll('.delete-user-btn');

        if (deleteButtons.length > 0) {
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-userid');
                    const userName = this.getAttribute('data-name');
                    const userEmail = this.getAttribute('data-email');
                    
                    deleteUserIdInput.value = userId;
                    deleteModal.classList.remove('hidden');
                });
            });
        }

        if (cancelDeleteBtn) {
            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.add('hidden');
            });
        }

        // Close modal when clicking outside
        if (deleteModal) {
            deleteModal.addEventListener('click', function(e) {
                if (e.target === deleteModal) {
                    deleteModal.classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>
