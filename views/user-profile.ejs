<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Ella Rises CRM</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background min-h-screen flex">
    <!-- Sidebar Navigation -->
    <%- include('partials/sidebar', { user: user, currentPage: 'profile' }) %>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 overflow-auto">
        <div class="space-y-6">
            <!-- Page Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-primary">Profile</h1>
                    <p class="text-muted-foreground mt-1">View and manage your profile information</p>
                </div>
            </div>

            <!-- Success Message -->
            <% if (typeof query !== 'undefined' && query.success === 'true') { %>
            <div id="successMessage" class="p-4 bg-green-50 border border-green-200 rounded-md">
                <p class="text-sm text-green-800">Profile updated successfully!</p>
            </div>
            <% } %>

            <!-- Require Profile Message -->
            <% if (requireProfile && isParticipant && !profileData) { %>
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                <p class="text-sm text-yellow-800">Please complete your profile information to access participant features.</p>
            </div>
            <% } %>

            <!-- Tab Navigation (only show for participants) -->
            <% if (isParticipant) { %>
            <div class="flex gap-3">
                <a href="/profile?tab=profile" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 <%= activeTab === 'profile' ? 'bg-primary text-primary-foreground hover:bg-primary/90' : 'bg-background text-foreground border border-input hover:bg-accent hover:text-accent-foreground' %> h-10 px-6 py-2">
                    Profile
                </a>
                <a href="/profile?tab=account" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 <%= activeTab === 'account' ? 'bg-primary text-primary-foreground hover:bg-primary/90' : 'bg-background text-foreground border border-input hover:bg-accent hover:text-accent-foreground' %> h-10 px-6 py-2">
                    Account Information
                </a>
            </div>
            <% } %>

            <!-- Profile Tab Content (for participants only) -->
            <% if (isParticipant && activeTab === 'profile') { %>
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold">Profile Information</h2>
                        <a href="/profile/edit?type=profile" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                            Edit
                        </a>
                    </div>
                    
                    <% if (profileData) { %>
                    <div class="space-y-6">
                        <div>
                            <p class="text-xs text-muted-foreground mb-1">Date of Birth</p>
                            <p class="text-lg font-semibold text-card-foreground">
                                <% if (profileData.profiledob) { %>
                                    <%= new Date(profileData.profiledob).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                                <% } else { %>
                                    <span class="text-muted-foreground/60 italic">Not set</span>
                                <% } %>
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-muted-foreground mb-1">Phone Number</p>
                            <p class="text-lg font-semibold text-card-foreground">
                                <% if (profileData.profilephone) { %>
                                    <% 
                                        const phone = profileData.profilephone.replace(/\D/g, '');
                                        let formattedPhone = profileData.profilephone;
                                        if (phone.length === 10) {
                                            formattedPhone = `(${phone.slice(0, 3)}) ${phone.slice(3, 6)}-${phone.slice(6)}`;
                                        }
                                    %>
                                    <%= formattedPhone %>
                                <% } else { %>
                                    <span class="text-muted-foreground/60 italic">Not set</span>
                                <% } %>
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-muted-foreground mb-1">Address</p>
                            <p class="text-lg font-semibold text-card-foreground">
                                <% 
                                const city = profileData.profilecity || '';
                                const state = profileData.profilestate || '';
                                const zip = profileData.profilezip || '';
                                const locationParts = [];
                                if (city) locationParts.push(city);
                                if (state) locationParts.push(state);
                                if (zip) locationParts.push(zip);
                                const fullLocation = locationParts.join(', ');
                                %>
                                <% if (fullLocation) { %>
                                    <%= fullLocation %>
                                <% } else { %>
                                    <span class="text-muted-foreground/60 italic">Not set</span>
                                <% } %>
                            </p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <p class="text-xs text-muted-foreground mb-1">School or Employer</p>
                                <p class="text-lg font-semibold text-card-foreground">
                                    <% if (profileData.profileschooloremployer) { %>
                                        <%= profileData.profileschooloremployer %>
                                    <% } else { %>
                                        <span class="text-muted-foreground/60 italic">Not set</span>
                                    <% } %>
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-muted-foreground mb-1">Field of Interest</p>
                                <p class="text-lg font-semibold text-card-foreground">
                                    <% if (profileData.profilefieldofinterest) { %>
                                        <%= profileData.profilefieldofinterest %>
                                    <% } else { %>
                                        <span class="text-muted-foreground/60 italic">Not set</span>
                                    <% } %>
                                </p>
                            </div>
                        </div>
                    </div>
                    <% } else { %>
                    <div class="text-center py-8">
                        <p class="text-muted-foreground mb-4">No profile information found. Please complete your profile.</p>
                        <a href="/profile/edit?type=profile" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                            Complete Profile
                        </a>
                    </div>
                    <% } %>
                </div>
            </div>
            <% } %>

            <!-- Account Information Tab Content (for all users) -->
            <% if ((isParticipant && activeTab === 'account') || isDonor) { %>
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold">Account Information</h2>
                        <a href="/profile/edit?type=account" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                            Edit
                        </a>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <p class="text-xs text-muted-foreground mb-1">Email Address</p>
                            <p class="text-lg font-semibold text-card-foreground break-all">
                                <% if (dbUser.useremail) { %>
                                    <%= dbUser.useremail %>
                                <% } else { %>
                                    <span class="text-muted-foreground/60 italic">Not set</span>
                                <% } %>
                            </p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <p class="text-xs text-muted-foreground mb-1">First Name</p>
                                <p class="text-lg font-semibold text-card-foreground">
                                    <% if (dbUser.userfirstname) { %>
                                        <%= dbUser.userfirstname %>
                                    <% } else { %>
                                        <span class="text-muted-foreground/60 italic">Not set</span>
                                    <% } %>
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-muted-foreground mb-1">Last Name</p>
                                <p class="text-lg font-semibold text-card-foreground">
                                    <% if (dbUser.userlastname) { %>
                                        <%= dbUser.userlastname %>
                                    <% } else { %>
                                        <span class="text-muted-foreground/60 italic">Not set</span>
                                    <% } %>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Convert to Participant Button (for donors only) -->
                    <% if (isDonor) { %>
                    <div class="mt-8 pt-6 border-t border-border">
                        <h3 class="text-lg font-semibold mb-2">Become a Participant</h3>
                        <p class="text-sm text-muted-foreground mb-4">Convert your account to a participant profile to register for events and achieve milestones.</p>
                        <button id="convertToParticipantBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-secondary text-secondary-foreground hover:bg-secondary/80 h-10 px-4 py-2">
                            Convert to Participant
                        </button>
                    </div>
                    <% } %>
                </div>
            </div>
            <% } %>
        </div>
    </main>

    <!-- Convert to Participant Confirmation Modal -->
    <div id="convertModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-card rounded-lg border border-border shadow-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus text-primary">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <line x1="19" y1="8" x2="19" y2="14"></line>
                            <line x1="22" y1="11" x2="16" y2="11"></line>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-card-foreground">Convert to Participant</h3>
                        <p class="text-sm text-muted-foreground mt-1">Confirm your account conversion</p>
                    </div>
                </div>
                <div class="mb-6">
                    <p class="text-sm text-card-foreground">
                        Your account will be converted to a participant profile so you can register for events and achieve milestones. 
                        After conversion, you'll be required to complete your profile information.
                    </p>
                </div>
                <div class="flex gap-3 justify-end">
                    <button id="cancelConvertBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Cancel
                    </button>
                    <button id="confirmConvertBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        Confirm Conversion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-hide success message
        const successMessage = document.getElementById('successMessage');
        if (successMessage) {
            setTimeout(() => {
                successMessage.style.transition = 'opacity 0.5s';
                successMessage.style.opacity = '0';
                setTimeout(() => {
                    successMessage.remove();
                }, 500);
            }, 5000);
        }

        // Donor conversion confirmation modal
        const convertBtn = document.getElementById('convertToParticipantBtn');
        const convertModal = document.getElementById('convertModal');
        const cancelConvertBtn = document.getElementById('cancelConvertBtn');
        const confirmConvertBtn = document.getElementById('confirmConvertBtn');

        if (convertBtn && convertModal) {
            // Open modal
            convertBtn.addEventListener('click', function() {
                convertModal.classList.remove('hidden');
            });

            // Close modal on cancel
            if (cancelConvertBtn) {
                cancelConvertBtn.addEventListener('click', function() {
                    convertModal.classList.add('hidden');
                });
            }

            // Close modal on backdrop click
            convertModal.addEventListener('click', function(e) {
                if (e.target === convertModal) {
                    convertModal.classList.add('hidden');
                }
            });

            // Confirm conversion
            if (confirmConvertBtn) {
                confirmConvertBtn.addEventListener('click', function() {
                    // Create a form and submit it
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/profile/convert-to-participant';
                    
                    document.body.appendChild(form);
                    form.submit();
                });
            }
        }
    </script>
</body>
</html>

